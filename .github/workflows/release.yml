name: Release Extension

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y glib2.0-dev libglib2.0-dev-bin zip
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create extension package
      run: |
        EXTENSION_UUID="AlwaysOnTop@Siddharthh39.github.io"
        TEMP_DIR="/tmp/gnome-extension-package"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        PACKAGE_NAME="always-on-top-v${VERSION}.zip"
        
        # Create temp directory
        mkdir -p "$TEMP_DIR/$EXTENSION_UUID"
        
        # Copy extension files
        cp metadata.json "$TEMP_DIR/$EXTENSION_UUID/"
        cp extension.js "$TEMP_DIR/$EXTENSION_UUID/"
        cp prefs.js "$TEMP_DIR/$EXTENSION_UUID/"
        cp stylesheet.css "$TEMP_DIR/$EXTENSION_UUID/"
        cp settings.ui "$TEMP_DIR/$EXTENSION_UUID/"
        cp -r icons/ "$TEMP_DIR/$EXTENSION_UUID/"
        cp -r schemas/ "$TEMP_DIR/$EXTENSION_UUID/"
        
        # Compile schemas
        cd "$TEMP_DIR/$EXTENSION_UUID/schemas"
        glib-compile-schemas .
        
        # Create package
        cd "$TEMP_DIR"
        zip -r "$PACKAGE_NAME" "$EXTENSION_UUID"
        
        # Move to workspace
        mv "$PACKAGE_NAME" "$GITHUB_WORKSPACE/"
        
        echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
        
    - name: Create source package
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        SOURCE_PACKAGE="always-on-top-source-v${VERSION}.zip"
        
        # Create source package excluding generated files
        zip -r "$SOURCE_PACKAGE" . \
          -x "*.zip" \
          -x ".git/*" \
          -x ".github/*" \
          -x "dist/*" \
          -x "schemas/gschemas.compiled"
          
        echo "SOURCE_PACKAGE=$SOURCE_PACKAGE" >> $GITHUB_ENV
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ${{ env.PACKAGE_NAME }}
          ${{ env.SOURCE_PACKAGE }}
        body: |
          ## Always On Top Extension v${{ steps.get_version.outputs.VERSION }}
          
          ### üöÄ Installation
          
          #### For Users:
          1. Download `${{ env.PACKAGE_NAME }}`
          2. Go to [GNOME Extensions](https://extensions.gnome.org/)
          3. Upload the zip file
          
          #### For Developers:
          - Download `${{ env.SOURCE_PACKAGE }}` for the complete source code
          
          ### üìã What's New
          
          <!-- Add changelog here -->
          
          ### üîß Manual Installation
          
          ```bash
          # Extract and install
          unzip ${{ env.PACKAGE_NAME }}
          cp -r AlwaysOnTop@Siddharthh39.github.io ~/.local/share/gnome-shell/extensions/
          
          # Enable extension
          gnome-extensions enable AlwaysOnTop@Siddharthh39.github.io
          
          # Restart GNOME Shell (X11 only)
          # Alt+F2, type 'r', press Enter
          ```
          
          ### üêõ Bug Reports
          
          Report issues at: https://github.com/Siddharthh39/Always-On-Top/issues
          
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        cp LICENSE extension-package/
        
        # Create zip file
        cd extension-package
        zip -r ../AlwaysOnTop@Siddharthh39.github.io.zip .
        cd ..

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: Always On Top ${{ steps.get_version.outputs.version }}
        body: |
          ## üéâ Always On Top Extension ${{ steps.get_version.outputs.version }}
          
          ### üì• Installation
          
          **Quick Install:**
          ```bash
          curl -fsSL https://raw.githubusercontent.com/Siddharthh39/Always-On-Top/main/install.sh | bash
          ```
          
          **Manual Install:**
          1. Download the `AlwaysOnTop@Siddharthh39.github.io.zip` file below
          2. Extract it to `~/.local/share/gnome-shell/extensions/AlwaysOnTop@Siddharthh39.github.io/`
          3. Restart GNOME Shell
          4. Enable the extension: `gnome-extensions enable AlwaysOnTop@Siddharthh39.github.io`
          
          ### ‚ú® Features
          - Toggle windows always-on-top with left click or keyboard shortcut
          - Configurable keyboard shortcuts (default: Super+T)
          - Window stickiness across workspaces
          - Visual indicators for different window states
          - Customizable panel position and ranking
          
          ### üêõ Bug Reports
          Please report any issues on the [Issues page](https://github.com/Siddharthh39/Always-On-Top/issues).
          
          ### üôè Support
          If you find this extension useful, please ‚≠ê star the repository!
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./AlwaysOnTop@Siddharthh39.github.io.zip
        asset_name: AlwaysOnTop@Siddharthh39.github.io.zip
        asset_content_type: application/zip

    - name: Upload Install Script
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./install.sh
        asset_name: install.sh
        asset_content_type: text/plain
